const chokidar = require('chokidar');

const ignored = [
  'node_modules/**', 'bower_components/**',
  '.git', '.hg', '.svn', '.DS_Store',
  '*.swp', 'thumbs.db', 'desktop.ini'
];

module.exports = function (paths, opts = {}) {
  const watcher = chokidar.watch(paths, Object.assign({}, opts, {
    ignored: ignored.concat(opts.ignoreWatch || []).filter(Boolean),
    usePolling: opts.poll,
    ignoreInitial: true,
    cwd: opts.cwd
  }));

  let closed = false;
  let ready = false;
  const closeFn = watcher.close;

  // patch chokidar close function for fsevents on OSX to avoid uv_close error
  // https://github.com/paulmillr/chokidar/issues/612
  watcher.once('ready', function () {
    ready = true;
    if (closed) closeFn.call(watcher);
  });

  watcher.isClosed = () => closed;
  watcher.close = close;
  return watcher;

  function close () {
    if (closed) return;
    if (ready) closeFn.call(watcher);
    closed = true;
  }
};
