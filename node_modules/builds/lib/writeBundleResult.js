const fs = require('fs');
const path = require('path');
const mkdirp = require('mkdirp');
const pify = require('pify');

const writeAsync = pify(fs.writeFile);
const mkdirAsync = pify(mkdirp);

module.exports = function (result, opts = {}) {
  const outputDir = opts.dir;
  const outputs = [
    { file: opts.js, data: result.code },
    { file: opts.css, data: result.css.code }
  ];
  return mkdirAsync(outputDir).then(write).then(() => result);

  function write () {
    return Promise.all(outputs.map(item => {
      return item.file
        ? writeDirAndFile(path.join(opts.dir, item.file), item.data)
        : Promise.resolve();
    }));
  }

  function writeDirAndFile (file, data) {
    return mkdirAsync(path.dirname(file))
      .then(() => writeAsync(file, data));
  }
};
