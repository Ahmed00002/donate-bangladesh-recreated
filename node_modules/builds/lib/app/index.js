const path = require('path');
const defined = require('defined');

const Config = require('electron-config');
const config = new Config();
const fs = require('fs');

const WindowManager = require('./WindowManager');
const createMenu = require('./createMenu');

const { app, BrowserView, BrowserWindow, ipcMain } = require('electron');
app.commandLine.appendSwitch('disable-http-cache');
app.commandLine.appendSwitch('v', 0);
app.commandLine.appendSwitch('vmodule', 'console=0');

const texel = require('../../');

// Disable security warnings for now
process.env.ELECTRON_DISABLE_SECURITY_WARNINGS = true;

function start () {
  let menu = createMenu();
  let mainWindow = new WindowManager();
  let server;
  ipcMain.on('open-directory', (_, file) => {
    let stat;
    console.log('opening', file);
    try {
      stat = fs.statSync(file);
    } catch (err) {
      console.error(err);
      return;
    }

    const dir = stat.isDirectory() ? file : path.dirname(file);
    server = texel.start({
      entries: 'index.js',
      cwd: dir
    }).once('connect', ev => {
      mainWindow.create();
      mainWindow.loadView(ev.url);
    });
  });

  ipcMain.on('back', ev => {
    console.log('go back');
  });
  ipcMain.on('forward', ev => {
    console.log('go fwd');
  });
  ipcMain.on('reload', ev => {
    mainWindow.reload();
  });

  app.once('before-quit', () => {
    if (server) {
      server.close();
      server = null;
    }
  });
  app.once('ready', () => {
    menu.create();
    mainWindow.create();
  });
  app.on('window-all-closed', () => {
    if (process.platform !== 'darwin') {
      app.quit();
    }
  });
  app.on('activate', () => mainWindow.create());

  menu.on('toggleDevTools', () => {
    mainWindow.toggleDevTools();
  });
  menu.on('toggleWindowDevTools', () => {
    if (mainWindow.window) {
      if (mainWindow.window.webContents.isDevToolsOpened()) {
        mainWindow.window.webContents.closeDevTools();
      } else {
        mainWindow.window.webContents.openDevTools({ mode: 'detach' });
      }
    }
  });
  menu.on('reload', () => {
    mainWindow.reload();
  });
  menu.on('reloadAll', () => {
    if (mainWindow.window) mainWindow.window.webContents.reload();
  });
}

start();


// let win = null
// let devtools = null

// app.once('ready', () => {
  
//   let win = new BrowserWindow({width: 800, height: 600})
//   win.on('closed', () => {
//     win = null
//   })

//   let view = new BrowserView({
//     webPreferences: {
//       nodeIntegration: false
//     }
//   })
//   win.setBrowserView(view)
//   view.setBounds({ x: 0, y: 0, width: 300, height: 300 })
//   view.webContents.loadURL('https://electronjs.org')
//   view.webContents.openDevTools();
//   // view.webContents.setDevToolsWebContents(win.webContents)
//   // view.webContents.openDevTools({mode: 'detach'})
// })